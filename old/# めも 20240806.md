# AsIs外部設計書復元の目的
リビルド開発のToBeの外部設計書作成のインプットとするため。
ToBe外部設計書ではCOBOL依存だったデータ型の変更や、それに伴う処理ロジックの最適化の実施。
DBアクセス方法の再検討を含む外部インタフェースへのアクセス方針の見直しを実施する。
そのため、AsIsジョブ設計書としては、通常外部設計相当として復元する情報とは異なる観点で内容を確認す流必要がある。

# 処理ロジックの採番ルール　
大項番：複数のある程度意味のあるSECTIONの単位、項番に対応する処理は見出しとして「～処理」の形で名詞の形で記載する。	
中項番：SECTION/PARAGRAPHの単位(PERFORM/GO TOで呼び出される単位)	
小項番：複合文、文、または文の集合の単位で、採番方法は以下のものとする。
複合文ごとに一つの採番を行うものとする。また複合文の中に複数文や複合文がある場合には、ソースコードの上から順に採番して処理を書いていくものとする。
その他は文の単位で採番する。ただし、

大項目以下の処理に該当するものは、SECTIONやPARAGRAPHの単位で呼び出し関係において連結なものに関して同じ処理としてまとめることとする。
それぞれの分類ごとに大項目に処理名称をつけて記載するものとする。

データの取得、生成に関わる処理
データのチェック、編集に関わる処理
データを保存する処理

ソースコードを上記の単位に

# めも　20240806






【前提】

1. 以下の項目に関しては定型文を記載するため品質観点チェックを行わないものとする。
    事前条件
    システム名
    業務ID/業務名
    ユースケースID/ユースケース名
    作成者
    作成日
    起動パラメータ

2. 今回は画面や帳票は出てこないジョブ設計書のため、以下画面や帳票については省略する。

3. 今,回のジョブ設計書以外の外部設計相当の設計書、内部設計相当の設計書、ソースコードはすでに存在しているものとする。

4. 今回は3.の条件を満たすため、AsIsのジョブ設計書はファイル、テーブル名称やデータ項目名の記載を物理名のまま記載してもよいものとする。


【用語】
- ソースコード処理ロジック：設計書の処理ロジックに対応する復元対象のCOBOLソースコードブロックのこととする。ただし、設計書は採番ルールにのっとって記載されているものとし、復元対象のOCBOLソースコードはPERFORM句はすべて呼び出し先のSECTIONやPARAGRAPHを呼び出し元部分に展開したものを表すとする。(今回復元対象のソースコードはCALLされている処理はすべて共通処理のため、今回は共通処理の展開については考えないものとする。)
- 処理ロジック名：処理ロジックの大項番の後に記載されている単語、もしくは文
- インタフェース(ファイル、画面、帳票、DB、共通部品) 


【処理フロー】
設計書内の統一
ソースコードのすべての反映
ソースコードとの矛盾のなさ
記載の明確さ
    定義をかいているか
    文言の書き方が良いか

- 🙆‍♀️処理ロジックの大項目に対応する処理ロジック図がそれぞれ一個ずつ存在するか。
- 🙆‍♀️各処理ロジック図に項番と処理ロジック名(処理ロジックの大項番の後に記載されている単語、もしくは文)が記載されているか。
- 🙆‍♀️ソースコードに登場するインタフェース(ファイル、画面、帳票、DB、共通部品)がすべて処理フローの中で、該当するインタフェース凡例図を用いて記載されているか。
- 🙆‍♀️インタフェース凡例図の中にはそれぞれファイル名、画面名、帳票名、テーブル名、共通部品名が記載されているか。
- 🙆‍♀️処理ロジック図とアクセスするインタフェースのインタフェース凡例図がデータの流れ図によって、ソースコードと矛盾なく紐づいているか。(アクセスがある場合のすべてのデータの流れ図が表現されているか。)ただしインタフェースに複数回アクセスがある場合にはそれぞれの方向について一回のみデータの流れ図を記載するものとする。
- 🙆‍♀️処理ロジック図とアクセスする他の処理ロジック図が処理の流れ図によって、ソースコードと矛盾なく紐づいているか。またそれぞれの処理ロジックの間に条件分岐がある場合には条件分岐ボックスをもちいて記載されているか。
- 🙆‍♀️条件分岐図から出ている処理の流れ図の数と条件分岐のパターン数が一致しているか。
- 🙆‍♀️条件分岐図から出ている処理の流れ図の[]の中に分岐の条件が記載され、その条件がソースコードと一致しているか。
- 🙆‍♀️処理開始と処理終了が処理フローの中にそれぞれ一つずつ記載されているか。また処理開始から処理ロジックボックスに処理の流れが紐づいており、処理ロジックボックスの最後の項番の処理から処理終了へ処理の流れが紐づいているか。
- 🙆‍♀️処理ロジック図に記載の処理ロジック名が設計書を通して統一されているか。
- 🙆‍♀️インタフェース凡例図に記載のインタフェース名(ファイル名、テーブル名、共通部品名)がすべて設計書を通して統一されているか。
  


   
【入力値チェック】
- 処理ロジックの記載内容の中から、入力値チェックを実施している部分を抽出し、以下の内容を表形式で記載されているか、確認する。
    項番、対象(今回はチェック項目が存在するファイル名、もしくはDBのテーブル名)、入力チェック項目名(カラム名)、チェック条件、処理ロジック項番(入力チェックを実施する処理ロジックの項番)


【処理ロジック】
- 採番ルール
    後述★
- 処理ロジック　
    インタフェース
        インタフェースに関して以下の項目を記載していること。
        項番
        対象名
        項目名　
        条件
        返却件数
        備考


【エラー処理】
    項番
    エラーコード
    メッセージ内容
    備考

【終了コード】
    項番
    論理項目名
    論理データ型
    備考








3	一貫性	語句の定義やその説明が複数箇所でなされいる場合、その内容が同一である。	"処理フロー：
各処理ロジック図に記載の大項目の処理ロジック名が設計書を通して統一されているか。。インタフェース名(ファイル名、テーブル名、共通部品名)がすべて設計書を通して統一されているか。
処理ロジック：
大項目の処理ロジック名が設計書を通して統一されているか。
インタフェース名(ファイル名、テーブル名、共通部品名)がすべて設計書を通して統一されているか。"
6	完全性	機能、性能、設計制約、属性、外部インタフェースに関する要求がすべて記載されている。	"処理フロー：
処理ロジックの大項目に対応する処理ロジック図がそれぞれ一個ずつ存在するか。
ソースコードに登場するインタフェース(ファイル、画面、帳票、DB、共通部品)がすべて処理フローの中で、該当するインタフェース凡例図を用いて記載されているか。インタフェース凡例図の中にはそれぞれファイル名、画面名、帳票名、テーブル名、共通部品名が記載されているか。
処理ロジック図とアクセスする他の処理ロジック図が処理の流れ図によって、ソースコードと矛盾なく紐づいているか。
またそれぞれの処理ロジックの間に条件分岐がある場合には条件分岐ボックスを用いて記載されているか。
処理ロジック：
採番ルールにのっとって採番がされており、処理ロジック大項目には処理名称が記載されているか。またファイルやテーブルアクセスに関する処理の場合、ファイル名、テーブル名、項目名、条件、返却件数が記載されているか。"
10	修正容易性	要求が冗長でないこと。	"処理フロー：同じ処理は同一の処理ロジックボックスで表現されていることを確認。

処理ロジック：同じ処理の内容が複数、別の項番の処理ロジックとして記載されていないことを確認する。"
11	修正容易性	複雑な要求を一つの要求として表現せずに、個々の要求を分離して別々に表現すること。	"処理フロー：
処理ロジック図は処理ロジックの大項番単位で記載されているか。
処理ロジック：
ソースコードの処理ロジックが、採番ルールにのっとって採番されて記載されているか。"
15	正当性	要求文ソフトウェアが真に満たすべき文のみが記載されている。	"処理フロー：
ソースコードにある処理ロジックや、共通部品、DB、インタフェース、帳票のみ記載されているか。
条件分岐図から出ている処理の流れ図の数と条件分岐のパターン数が一致しているか。
条件分岐図から出ている処理の流れ図の[]の中に分岐の条件が記載され、その条件がソースコードと一致しているか。
ソースコードに登場するインタフェース(ファイル、画面、帳票、DB、共通部品)のみ処理フローの中で、該当するインタフェース凡例図を用いて記載されているか。
処理ロジック：
ソースコードにある処理ロジックのみ記載されているか。"
18	無あいまい性	語句の係り受け関係が複数ある記載でないか	処理フロー：処理ロジックボックスやインタフェース項目すべてに名称や項番が記載されており、また処理ロジック欄のいずれの記述にも大項番、中項番、小項番のいずれかの番号が採番されていること。
19	無あいまい性	主語や目的語が省略されていないか	"処理フロー：
-
処理ロジック：
主語や目的語が省略されていない文で記載されているか。"
20	無あいまい性	指示語を含まないか	"処理フロー：
-
処理ロジック：
指示語を使っていない文で記載されているか。"
21	無あいまい性	「使いやすく」、や「見栄えよく」などそれを達成したかどうかの判断基準が読み手によって変化しうる記載かどうか	"処理フロー：
-
処理ロジック：
指示語を使っていない文で記載されているか。"





# 参考文献
- NDCM版TERASOLUNA開発手順
https://tera-ped-repo.x-network.jp/quwf/ndcm_for_japan/02_%E9%96%8B%E7%99%BA%E6%89%8B%E9%A0%86/01_%E6%9C%AC%E7%B7%A8/04_%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E6%A7%8B%E7%AF%89%E7%B7%A8/5_%E5%87%A6%E7%90%86%E8%A8%AD%E8%A8%88.html

- IEEE要求工学について1
https://tera-ped-repo.x-network.jp/quwf/ndcm_for_japan/02_%E9%96%8B%E7%99%BA%E6%89%8B%E9%A0%86/01_%E6%9C%AC%E7%B7%A8/04_%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E6%A7%8B%E7%AF%89%E7%B7%A8/5_%E5%87%A6%E7%90%86%E8%A8%AD%E8%A8%88.html

- IEEE要求工学について2
https://ipsj.ixsq.nii.ac.jp/ej/?action=repository_action_common_download&item_id=60916&item_no=1&attribute_id=1&file_no=1





処理タイプ一覧
入力チェック
メッセージ出力
制御構造（分岐、繰り返し）
演算
編集処理
エラー処理
外部システムとの連携
他COBOLの呼び出し
DBアクセス処理
ファイル入出力処理
帳票出力処理



ジョブ設計書の処理ロジックは項番1, 1.1, 1.1.1...の形で項番を振って処理の内容を階層に分けて記述するとする。	
順に大項番、中項番、小項番と呼ぶこととし、それ以降の項番の採番はしないものとする。	
    
ソースコード処理ロジック：設計書の処理ロジックに対応する復元対象のCOBOLソースコードブロックのこととする。	
ただし、設計書は採番ルールにのっとって記載されているものとし、	
復元対象のOCBOLソースコードはPERFORM句はすべて呼び出し先のSECTIONやPARAGRAPHを呼び出し元部分に展開したものを表すとする。	
(今回復元対象のソースコードはCALLされている処理はすべて共通処理のため、今回は共通処理の展開については考えないものとする。)	
    
大項番：複数のある程度意味のあるSECTIONの単位、項番に対応する処理は見出しとして「～処理」の形で名詞の形で記載する。	
中項番：SECTIONの単位	
小項番：単一の処理タイプとして記載可能な単位に分割したソースコードに対応する処理の単位で記載する。	
    ただし、中項番がすでに単一の処理タイプとして記載可能の場合は小項番は採番不要とする。



PROCEDURE　DIVISIONをSECTIONを単位で確認し、さらにそれぞれ処理タイプ単位で分割して、分割した処理ごとに処理の概要を記載して下さい。
また分割した処理ごとにアクセス対象のテーブル、ファイルがある場合にはそのテーブル名、ファイル名、カラム名、アクセス条件を明記して併せて出力してください。


# 大切なのは外部、内部インタフェース

外部インタフェース系
PERFORM
GO TO
CALL
EXEC SQL
OPEN, READ, WRITE, CLOSE
DISPLAY,ACCEPT
SYSIN/SYSPRINT	


LINKAGE SECTION	
EXEC DLI	
CICS

SECTION単位で記する　中項番


外部インタフェース設計


COBOL

1ファイル　 = 処理
1 SECTION = SECTION
1 PARAGRAPH = PARAGRAPH

必須
CALL呼び出し⭐️
PERFORM呼び出し⭐️
DBアクセス処理 EXEC SQL
ファイルアクセス処理 ⭐️
編集処理⭐️

コンソール/端末インタフェース
JCLインタフェース (SYSIN, SYSPRINT)

その他バージョンによって利用される可能性がある
- **CICSインタフェース (EXEC CICS)**
  - IBMのCICSトランザクションサーバーを介して、トランザクション処理やデータベースアクセスを行うインタフェース。

- **メッセージキューインタフェース (MQ)**
  - IBM WebSphere MQなどのメッセージキューシステムを通じて、メッセージの送受信を行うインタフェース。

- **IMSインタフェース (EXEC DLI)**
  - IBMのIMS（Information Management System）データベースにアクセスするためのインタフェース。

- **ソート/マージインタフェース (SORT, MERGE)**
  - 外部ソートユーティリティと連携してデータのソートやマージを行うためのインタフェース。



COBOLソース
処理ブロックとは



処理には
順次処理
分岐
反復

順次処理は⭐️マークの種類ごとに記載する

分岐処理は処理の先の処理が単一処理タイプかつ同一処理タイプの場合は分岐として表現せず、その処理タイプの処理として記載する。
それ以外は分岐処理として記載すること

処理タイプの判断はCOBOLの文ごとに実施すること。


反復処理は反復処理として切り出すこと

処理の中で外部インタフェースに該当するものは

AsIsの外部設計書として
どの外部インタフェースの、どの項目に、どのような条件でアクセスしているか。
それらの項目を内部でどのように操作しているか。

単純な値の代入等ならば記載不要



    PERFORM UNTIL EOF-REACHED
        READ INPUT-FILE INTO WS-CURRENT-RECORD
            AT END
                SET EOF-REACHED TO TRUE
            NOT AT END
                ADD 1 TO WS-RECORD-COUNT
                MOVE WS-CURRENT-RECORD(1:10) TO WS-EDITED-STRING
                
                IF WS-EDITED-STRING = "DISCOUNTED"
                    COMPUTE WS-DISCOUNT-AMOUNT = WS-CURRENT-RECORD(11:18) * 0.9
                    MOVE WS-DISCOUNT-AMOUNT TO WS-FINAL-AMOUNT
                ELSE
                    MOVE WS-CURRENT-RECORD(11:18) TO WS-FINAL-AMOUNT
                END-IF

                EXEC SQL
                    SELECT AMOUNT INTO :WS-DB-AMOUNT
                    FROM TRANSACTIONS
                    WHERE TRANSACTION-ID = :WS-EDITED-STRING
                END-EXEC

                IF SQLCODE = 0
                    ADD WS-DB-AMOUNT TO WS-TOTAL-AMOUNT
                    STRING "ID: " WS-EDITED-STRING ", Amount: " WS-FINAL-AMOUNT
                        DELIMITED BY SIZE
                        INTO WS-EDITED-STRING
                    DISPLAY WS-EDITED-STRING
                ELSE
                    DISPLAY "DB ERROR FOR ID: " WS-EDITED-STRING
                END-IF
        END-READ
    END-PERFORM.


    PERFORM UNTIL EOF-REACHED
    
    READ INPUT-FILE INTO WS-CURRENT-RECORD




    繰り返し処理(小項目)




大項目：複数のPARAGRAPH,SECTIONの単位(ここが難しい)
→外部インタフェース、共通部品へのアクセスで分ける。一時的にアクセスしているものに止める。
中項目：SECTION、もしくはPARAGRAPHの単位(PARAGRAPHに分かれている場合はPARAGRAPHの単位で採番する)
小項目：センテンス、センテンスの集合、もしくは複合文の単位

小項目に関して
複合文の場合は一つの採番で記述。
複合文の場合で、内部に複数の複合文を含む場合は
センテンス
センテンスの連続の場合は、連続するセンテンスの集合が同一のデータ項目に関連　

今回は復元のため条件分岐など、値の評価を含むセンテンスは全て採番して切り出すべき


COBOLのソースコードから外部設計書を復元する際には、ソースコードの構造と処理内容を正確に反映し、後からその設計書を参照する人がプログラムの動作を理解しやすいようにすることが重要です。以下に、記述粒度、採番ロジック、記述要領について厳密に定義します。

### 1. **記述粒度の設定**

記述粒度は、外部設計書でどの程度詳細に記載するかを決定する重要な要素です。基本的に、プログラムの主要な処理やロジックの単位で記述し、以下の階層に分けて記載します。

#### 階層1: **プログラムの概要**
- プログラム全体の目的と処理概要を記載します。
- 例: プログラムの目的、入力と出力、主要な処理の流れ。

#### 階層2: **処理単位（パラグラフまたはセクション単位）**
- プログラム内のパラグラフやセクションごとに記述します。
- 各パラグラフ/セクションがどのような処理を行っているかを記載します。

#### 階層3: **具体的な処理（センテンス単位）**
- 各パラグラフ/セクション内での具体的な処理を説明します。
- 条件分岐、ループ処理、ファイル操作、データベースアクセスなど、主要な処理ごとに記述します。

#### 階層4: **データの流れと入出力**
- ファイルやデータベースとのインタフェース、使用されるデータ項目の詳細を記載します。
- 変数やフィールドの定義、使用方法、関連する計算や変換などを説明します。

### 2. **採番ロジック**

採番ロジックは、外部設計書の各項目に一意の識別子を付与し、階層構造を反映させるために使用します。以下のルールに基づいて採番します。

#### 階層1: **プログラムの概要**
- 識別子: `1`
- 例: `1. プログラム概要`

#### 階層2: **処理単位**
- 識別子: `1.1`, `1.2`, `1.3` …
- 例: `1.1. 初期化処理`, `1.2. ファイル読み取り処理`

#### 階層3: **具体的な処理**
- 識別子: `1.1.1`, `1.1.2`, `1.2.1` …
- 例: `1.1.1. ファイルオープン`, `1.2.1. レコード読み取り`

#### 階層4: **データの流れと入出力**
- 識別子: `1.1.1.1`, `1.2.1.1` …
- 例: `1.2.1.1. INPUT-FILE レコードフォーマット`, `1.2.1.2. OUTPUT-FILE レコードフォーマット`

### 3. **記述要領**

#### 3.1 **プログラムの概要記述**
- **目的**: プログラムが達成する目的を簡潔に記述します。
- **入力**: プログラムが処理する入力（ファイル、データベース、引数など）を記載します。
- **出力**: プログラムの出力（生成するファイル、データベース更新など）を記載します。
- **処理の流れ**: 高レベルでの処理の流れを記載し、後続の詳細説明の枠組みを提供します。

**記述例**:
```
1. プログラム概要
1.1 目的:
    本プログラムは、入力ファイルからレコードを読み取り、データベースに記録し、結果を出力ファイルに保存する。
1.2 入力:
    - INPUT-FILE: トランザクションデータを含むテキストファイル
1.3 出力:
    - OUTPUT-FILE: 処理結果を記録するテキストファイル
    - DATABASE: トランザクションテーブル
1.4 処理の流れ:
    1. ファイルのオープン
    2. レコードの読み取りと編集処理
    3. データベースの更新
    4. 結果の出力
    5. ファイルのクローズ
```

#### 3.2 **処理単位の記述**
- **目的**: 各パラグラフやセクションが担当する機能を記述します。
- **処理内容**: 処理の流れと主要な操作を記載します。

**記述例**:
```
1.5 ファイル読み取り処理
1.5.1 レコード読み取り:
    1. INPUT-FILEから1レコードを読み込み、WS-RECORDに格納する。
    2. レコードのステータスをチェックし、終端に達した場合はEOFフラグを設定する。

1.5.2 データの編集:
    1. レコードの特定のフィールド（フィールド名）を抽出し、WS-EDITED-FIELDに格納する。
    2. WS-EDITED-FIELDに対してフォーマット処理を行う。
```

#### 3.3 **具体的な処理の記述**
- **条件分岐**: 条件の内容と分岐後の処理を明確に記載します。
- **ループ処理**: 繰り返し条件と、ループ内で行われる処理を記載します。
- **データベースアクセス**: 使用するSQL文、操作対象のテーブルやフィールドを記載します。

**記述例**:
```
1.5.3 データベース更新
    1. WS-EDITED-FIELDの値をもとに、TRANSACTIONSテーブルを検索し、対応するレコードを取得する。
    2. 取得した金額フィールドを累積し、WS-TOTAL-AMOUNTに加算する。
    3. SQLCODEを確認し、成功した場合は、処理を継続し、失敗した場合はエラーメッセージを生成する。

1.5.4 出力処理:
    1. 編集されたデータをWS-OUTPUT-FIELDにフォーマットし、OUTPUT-FILEに書き込む。
    2. 書き込み後、次のレコード処理へ移行する。
```

#### 3.4 **データの流れと入出力の記述**
- **ファイルフォーマット**: ファイルのレイアウト、フィールドのデータ型、長さ、役割を記載します。
- **データベース**: テーブル名、フィールド名、データ型、関連するトランザクションを記載します。

**記述例**:
```
1.5.5 ファイルおよびデータベース
1.5.5.1 INPUT-FILE レコードフォーマット:
    - フィールド1: 取引ID, PIC X(10)
    - フィールド2: 金額, PIC 9(8)V99

1.5.5.2 TRANSACTIONS テーブル:
    - フィールド1: TRANSACTION-ID, CHAR(10)
    - フィールド2: AMOUNT, DECIMAL(10,2)
```

### まとめ

外部設計書の作成では、ソースコードを忠実に反映させつつ、読み手がプログラムの処理フローやデータの流れを理解できるように、階層的かつ体系的に情報を整理します。各処理単位やセンテンスごとの目的、処理内容、データの流れを明示し、記述粒度を適切に設定することで、詳細な外部設計書を作成することが可能です。